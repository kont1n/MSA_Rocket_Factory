name: Test Coverage

on:
  workflow_call:
    inputs:
      modules:
        required: true
        type: string
      go-version:
        required: true
        type: string
      golangci-lint-version:
        required: true
        type: string

jobs:
  test:
    name: test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: write
      pages: write

    steps:
      # tests
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Install Go
        uses: actions/setup-go@v5.4.0
        with:
          go-version: ${{ inputs.go-version }}

      - name: Verify dependencies
        run: go mod verify

      - name: Restore cache
        uses: actions/cache@v4.2.0
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-v1-go-${{ hashFiles('go.work.sum') }}
          restore-keys: |
            ${{ runner.os }}-v1-go-

      - name: Check and install dependencies
        run: |
          # ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ²ÑĞµ go.mod Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ go mod tidy Ğ² ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
          find . -name "go.mod" -type f | while read -r modfile; do
            dir=$(dirname "$modfile")
            echo "Processing module in: $dir"
            cd "$dir"
            go mod tidy
            cd - > /dev/null
          done
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ² go.mod Ğ¸ go.sum Ñ„Ğ°Ğ¹Ğ»Ğ°Ñ…
          git diff --exit-code **/go.mod
          git diff --exit-code **/go.sum

      - name: Install gocov-html
        run: |
          go install github.com/axw/gocov/gocov@v1
          go install github.com/matm/gocov-html/cmd/gocov-html@v1

      - name: Run tests
        run: |
          mkdir -p .github_pages
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ
          echo "mode: atomic" > coverage.out
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚ĞµÑÑ‚Ñ‹ Ğ²Ğ¾ Ğ²ÑĞµÑ… Ğ¼Ğ¾Ğ´ÑƒĞ»ÑÑ… Ğ¸ Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
          while IFS= read -r modfile; do
            dir=$(dirname "$modfile")
            echo "Running tests in: $dir"
            cd "$dir"
            
            # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ² Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ Ñ„Ğ°Ğ¹Ğ»
            go test ./... -coverprofile=tmp_coverage.out -covermode=atomic -coverpkg=./...
            if [ -f tmp_coverage.out ]; then
              # ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿ĞµÑ€Ğ²ÑƒÑ ÑÑ‚Ñ€Ğ¾ĞºÑƒ (mode: atomic) Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ
              # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿ÑƒÑ‚Ğ¸ Ğ¾Ñ‚ ĞºĞ¾Ñ€Ğ½Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
              awk 'NR>1' tmp_coverage.out >> ../../coverage.out
              rm tmp_coverage.out
            fi
            
            cd - > /dev/null
          done < <(find . -name "go.mod" -type f)
          
          # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ñ‹
          go tool cover -func=coverage.out -o=cover.out
          gocov convert coverage.out | gocov-html > .github_pages/index.html

      # pages
      - name: Setup Pages
        uses: actions/configure-pages@v5
        with:
          enablement: true

      - name: Upload Artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: .github_pages/

      - name: Upload Coverage Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            .github_pages/
            coverage.out
            cover.out
          retention-days: 30

      # badge - Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ main Ğ²ĞµÑ‚ĞºĞ¸
      - name: Update coverage Badge
        if: github.ref == 'refs/heads/main'
        uses: tj-actions/coverage-badge-go@v2
        with:
          text: Coverage_Report
          target: README.md
          filename: cover.out
          link: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
        continue-on-error: true

      - name: Verify Changed files
        if: github.ref == 'refs/heads/main'
        uses: tj-actions/verify-changed-files@v12
        id: verify-changed-files
        with:
          files: README.md

      - name: Commit changes
        if: github.ref == 'refs/heads/main' && steps.verify-changed-files.outputs.files_changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "chore: Updated coverage badge."

      - name: Push changes
        if: github.ref == 'refs/heads/main' && steps.verify-changed-files.outputs.files_changed == 'true'
        run: |
          git remote set-url origin https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git
          git push origin HEAD:${{ github.ref_name }}

  coverage:
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: write
      pages: write
      id-token: write

    # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¸Ğ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ main Ğ²ĞµÑ‚ĞºĞ¸ Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¸ pull request Ğ² main
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request' && github.base_ref == 'main'

    environment:
      name: github-pages

    steps:
      - name: Deploy coverage report to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        continue-on-error: true

      - name: Check deployment status
        if: steps.deployment.outcome == 'success'
        run: |
          echo "âœ… Coverage report successfully deployed to GitHub Pages"
          echo "ğŸ“Š Report available at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"

      - name: Deployment failed notice
        if: steps.deployment.outcome == 'failure'
        run: |
          echo "âš ï¸ GitHub Pages deployment failed"
          echo "ğŸ“‹ Coverage report is available as an artifact: coverage-report"
          echo "ğŸ”§ To enable GitHub Pages:"
          echo "   1. Go to repository Settings > Pages"
          echo "   2. Select 'GitHub Actions' as source"
          echo "   3. Re-run this workflow"

  # ĞÑ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ job Ğ´Ğ»Ñ Ğ²ĞµÑ‚Ğ¾Ğº, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ½Ğµ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¸Ñ‚ÑŒ Ğ½Ğ° Pages
  coverage-info:
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ²ĞµÑ‚Ğ¾Ğº, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ½Ğµ main
    if: github.ref != 'refs/heads/main' && github.event_name != 'pull_request'
    
    steps:
      - name: Coverage report info
        run: |
          echo "ğŸ“Š Coverage report generated successfully"
          echo "ğŸ“‹ Report is available as an artifact: coverage-report"
          echo "ğŸŒ To view the report on GitHub Pages, merge to main branch"
          echo "ğŸ“ You can download the artifact to view the report locally"